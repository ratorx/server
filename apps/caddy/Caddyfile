{
  admin off
  auto_https off
}

(auth) {
  basicauth {args.0} {
   admin {$CADDY_ADMIN_USER_PASSWORD_HASH} {$CADDY_ADMIN_USER_SALT}
  }
}

(app) {
  # Add trailing slash to all backend communication
  redir /app/{args.0} /app/{args.0}/
  handle_path /app/{args.0}/* {
    reverse_proxy {args.1}
  }
}

(tls) {
  tls /certs/live/default/fullchain.pem /certs/live/default/privkey.pem
}

(log) {
  log {
    format console
  }
}

(gh_shortlink) {
  @{args.0}_link {
    path /{args.0}*
    not path /{args.0}/*
  }
  rewrite @{args.0}_link /{args.1}{path}
}

https://{$MAIN_DOMAIN} {
  import tls
  import log
  encode gzip

  # Require authentication for all resources except the status page
  @notstatus {
    not path /status
  }
  import auth @notstatus

  redir /status https://status.{host}

  # Syncthing Admin UI
  import app syncthing syncthing:8384
  
  root * /usr/share/caddy
  file_server * browse {
    hide apps* config* *stfolder* *.git* *node_modules*
  }
}

https://{$GH_DOMAIN_ALIAS} {
  import tls
  import log
  import gh_shortlink sshca ratorx/sshca
  reverse_proxy * gh:8080
}

https:// {
  import tls
  import log
  respond 400
}

http:// {
  redir https://{host}{uri} permanent
}
